{% extends 'base.html' %}
{% load crispy_forms_tags %}

{% block title %}Cadastrar Cliente{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://npmcdn.com/flatpickr/dist/l10n/pt.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Inicializar flatpickr para campos de data
    flatpickr(".datepicker-br", {
        dateFormat: "d/m/Y",
        locale: "pt",
        allowInput: true,
        altInput: true,
        altFormat: "d/m/Y",
        disableMobile: true
    });
    
    // Máscaras simples de formatação
    const formatar = (campo, func) => campo && campo.addEventListener('input', () => func(campo));
    const cpfInput = document.getElementById('id_cpf_cliente');
    const telefoneInput = document.getElementById('id_telefone');
    const celularInput = document.getElementById('id_celular');
    const cepInput = document.getElementById('id_cep');
    
    formatar(cpfInput, formatarCPF);
    formatar(telefoneInput, formatarTelefone);
    formatar(celularInput, formatarTelefone);
    formatar(cepInput, formatarCEP);
});
</script>

<!-- Funções de formatação -->
<script>
function formatarCPF(input) {
    let valor = input.value.replace(/\D/g, '');
    if (valor.length > 11) valor = valor.slice(0, 11);
    valor = valor.replace(/(\d{3})(\d)/, '$1.$2');
    valor = valor.replace(/(\d{3})(\d)/, '$1.$2');
    valor = valor.replace(/(\d{3})(\d{1,2})$/, '$1-$2');
    input.value = valor;
}

function formatarTelefone(input) {
    let valor = input.value.replace(/\D/g, '');
    if (valor.length > 11) valor = valor.slice(0, 11);
    if (valor.length <= 10) {
        valor = valor.replace(/(\d{2})(\d{4})(\d{0,4})/, '($1) $2-$3');
    } else {
        valor = valor.replace(/(\d{2})(\d{5})(\d{0,4})/, '($1) $2-$3');
    }
    input.value = valor;
}

function formatarCEP(input) {
    let valor = input.value.replace(/\D/g, '');
    if (valor.length > 8) valor = valor.slice(0, 8);
    valor = valor.replace(/(\d{5})(\d{0,3})/, '$1-$2');
    input.value = valor;
}
</script>

<script>
document.getElementById('id_cep').addEventListener('blur', function() {
    const cep = this.value.replace(/\D/g, '');
    if (cep.length === 8) {
        fetch(`https://viacep.com.br/ws/${cep}/json/`)
        .then(response => response.json())
        .then(data => {
            if (!('erro' in data)) {
                document.getElementById('id_endereco').value = data.logradouro;
                document.getElementById('id_cidade').value = data.localidade;
                document.getElementById('id_uf').value = data.uf;
            } else {
                alert('CEP não encontrado.');
            }
        })
        .catch(() => alert('Erro ao buscar CEP.'));
    }
});
</script>

{% endblock %}

{% block content %}
<main id="conteudo-principal" class="row justify-content-center align-items-center min-vh-100" role="form" aria-labelledby="titulo-form">
    <div class="col-md-8">
        <div class="card p-4 shadow-sm">
            <h2 id="titulo-form" class="text-center mb-4">Cadastro de Cliente</h2>

            <form method="post" novalidate aria-describedby="instrucoes-form">
                {% csrf_token %}
                <p id="instrucoes-form" class="visually-hidden">
                    Preencha os campos obrigatórios. Use a tecla Tab para navegar entre os campos.
                </p>

                {% if form.non_field_errors %}
                    <div class="alert alert-danger" role="alert">
                        {{ form.non_field_errors }}
                    </div>
                {% endif %}

                <div class="row">
                    <div class="col-md-6">{{ form.nome_completo|as_crispy_field }}</div>
                    <div class="col-md-6">{{ form.cpf_cliente|as_crispy_field }}</div>
                </div>
                <div class="row">
                    <div class="col-md-6">{{ form.data_nascimento|as_crispy_field }}</div>
                    <div class="col-md-6">{{ form.telefone|as_crispy_field }}</div>
                </div>
                <div class="row">
                    <div class="col-md-6">{{ form.celular|as_crispy_field }}</div>
                    <div class="col-md-6">{{ form.cep|as_crispy_field }}</div>
                </div>
                <div class="row">
                    <div class="col-md-8">{{ form.endereco|as_crispy_field }}</div>
                    <div class="col-md-4">{{ form.numero|as_crispy_field }}</div>
                </div>
                <div class="row">
                    <div class="col-md-6">{{ form.cidade|as_crispy_field }}</div>
                    <div class="col-md-2">{{ form.uf|as_crispy_field }}</div>
                    <div class="col-md-4">{{ form.complemento|as_crispy_field }}</div>
                </div>

                <div class="text-center mt-4">
                    <button type="submit" class="btn btn-primary btn-lg" aria-label="Salvar informações do cliente">
                        Salvar
                    </button>
                    <a href="{% url 'clientes:consultar_cliente' %}" class="btn btn-secondary btn-lg" aria-label="Voltar à lista de clientes">
                        Voltar
                    </a>
                </div>
            </form>
        </div>
    </div>
</main>
{% endblock %}
